<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>OAuth callback</title>
  <link rel="stylesheet" href="/style.css">
  <style>body{padding:40px;font-family:Arial, sans-serif;color:#fff;background:#000} .container{max-width:720px;margin:40px auto}</style>
</head>
<body>
  <main class="container">
    <h2 class="section-title">Handling OAuth callback...</h2>
    <p id="status" class="section-lead">Processing sign-in. If nothing happens, use the manual form below.</p>

    <div id="manual" style="margin-top:18px">
      <label style="display:block;margin-bottom:8px">Backend URL (where your server is running)</label>
      <input id="backend" type="text" placeholder="https://your-backend.example.com" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:white">
      <div style="margin-top:8px;display:flex;gap:8px"><button id="btn-send" class="btn primary">Send code to backend</button><button id="btn-try" class="btn ghost">Try common hosts</button></div>
      <p style="margin-top:8px;color:var(--muted);font-size:0.95rem">Common backend hosts: <code>http://localhost:3000</code> (dev) or your deployed backend URL.</p>
    </div>

    <pre id="debug" style="margin-top:18px;color:var(--muted);font-size:0.85rem"></pre>
  </main>

<script>
(async function(){
  const status = document.getElementById('status');
  const debug = document.getElementById('debug');
  const q = new URLSearchParams(window.location.search);
  const code = q.get('code'); const state = q.get('state');
  if (!code) { status.textContent = 'No code found in URL. Make sure Discord redirected here.'; return; }

  function log(...args){ debug.textContent += args.join(' ') + '\n'; }

  // Try posting to current origin first (good for localhost dev where server and frontend are same origin)
  const candidates = [ window.location.origin, 'http://localhost:3000' ];

  async function tryHost(host){
    try {
      status.textContent = `Attempting to POST to ${host}/callback ...`;
      log('POST =>', host + '/callback');
      const res = await fetch(host + '/callback', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify({ code, state, redirectUri: window.location.origin + '/callback' }) });
      log('Response status', res.status);
      if (res.ok) {
        const j = await res.json().catch(()=>null);
        status.textContent = 'Sign-in complete â€” redirecting...';
        log('Response json', JSON.stringify(j));
        // If backend returned redirect, follow it on backend host
        if (j && j.redirect) { window.location.href = host + j.redirect; return true; }
        // otherwise try to go to /dashboard on this host
        window.location.href = host + '/dashboard';
        return true;
      }
      const text = await res.text().catch(()=>'<no-body>');
      log('Failed:', res.status, text);
      return false;
    } catch (e){ log('Error trying', host, e); return false; }
  }

  // Attempt candidates in order
  for (const h of candidates){
    const ok = await tryHost(h);
    if (ok) return;
  }

  status.textContent = 'Automatic exchange failed. Paste your backend URL below and click "Send code to backend".';

  document.getElementById('btn-send').addEventListener('click', async ()=>{
    const host = document.getElementById('backend').value.trim();
    if (!host) { alert('Enter backend host'); return; }
    await tryHost(host);
  });

  document.getElementById('btn-try').addEventListener('click', async ()=>{
    const known = ['http://localhost:3000'];
    for (const k of known){ await tryHost(k); }
  });

})();
</script>
</body>
</html>