<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard</title>
  <link rel="stylesheet" href="/style.css">
  <style>.center{max-width:960px;margin:40px auto}.guild-grid{display:flex;gap:12px;flex-wrap:wrap}.guild-card{width:220px;padding:12px;border-radius:8px;background:rgba(255,255,255,0.03);text-align:center}</style>
</head>
<body>
  <main class="container">
    <div class="center">
      <h2 class="section-title">Dashboard</h2>
      <p id="lead" class="section-lead">Loading your serversâ€¦</p>
      <div id="guilds" class="guild-grid"></div>
      <p style="margin-top:18px"><a id="btn-login" class="btn primary" href="/api/auth">Sign in with Discord</a></p>
    </div>
  </main>

<script>
(async function(){
  const lead = document.getElementById('lead');
  const grid = document.getElementById('guilds');
  const btnLogin = document.getElementById('btn-login');
  try {
    const r = await fetch('/api/session', { credentials: 'include' });
    const j = await r.json();
    console.log('session response:', j);
    if (!j.ok) { lead.textContent = 'Please sign in to view your servers.'; 
      // Show debug info on the page to help find why sign-in failed
      const info = document.createElement('pre'); info.style.color='var(--muted)'; info.textContent = JSON.stringify(j, null, 2);
      document.body.appendChild(info);
      return; }
    const guilds = j.guilds || [];
    const allowed = guilds.filter(g => { try { if (g.owner) return true; const perms = BigInt(g.permissions || '0'); const ADMIN = 0x8n; const MANAGE_GUILD = 0x20n; return ((perms & (ADMIN | MANAGE_GUILD)) !== 0n); } catch(e){ return false; } });
    if (!guilds || guilds.length === 0) { lead.textContent = 'No servers found where you have admin or manage permissions.'; return; }
    lead.textContent = 'Choose a server to setup NoctisGuard.';
    grid.innerHTML = guilds.map(g => {
      const isAllowed = allowed.some(a => a.id === g.id);
      return `<div class="guild-card${isAllowed ? '' : ' disabled'}"><img src="https://cdn.discordapp.com/icons/${g.id}/${g.icon || 'a_none'}.png" alt="${g.name}" style="width:64px;height:64px;border-radius:8px;margin-bottom:8px" onerror="this.src='/img/placeholder.svg'"><h4>${g.name}</h4><p style="color:var(--muted);font-size:0.9rem">${g.id}</p>${isAllowed ? `<a class="btn ghost" href="/setup/${g.id}">Setup</a>` : `<span style="color:var(--muted);font-size:0.9rem">No access</span>`}</div>`;
    }).join('\n');
    btnLogin.style.display = 'none';
  } catch (e) { console.error(e); lead.textContent = 'Failed to load your servers'; }
})();
</script>
</body>
</html>